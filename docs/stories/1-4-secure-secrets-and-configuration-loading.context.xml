<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Secure secrets and configuration loading</title>
    <status>drafted</status>
    <generatedAt>2025-11-10T16:51:15Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-4-secure-secrets-and-configuration-loading.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a platform owner</asA>
    <iWant>I want Sheets API credentials, MongoDB connection strings, and signing keys loaded from Google Secret Manager at runtime through a shared secrets module</iWant>
    <soThat>sensitive data never lands in source control or logs and operators can rotate secrets without redeploying</soThat>
    <tasks>
  <task id="T1" ac="AC1">
    <summary>Implement lib/secrets.ts to fetch Google OAuth credentials, NextAuth signing key, Mongo URI, and Sheets service account JSON from Secret Manager with caching and rotation hooks.</summary>
    <subtasks>
      <item>Add unit tests that mock Secret Manager responses to exercise retry, backoff, cache invalidation, and rotation updates.</item>
    </subtasks>
    <sources>docs/architecture.md:145; docs/architecture.md:293</sources>
  </task>
  <task id="T2" ac="AC2">
    <summary>Extend lib/config.ts to merge Story A1 config collection entries (allowlist, sheet ID, collection metadata) with hydrated secrets and expose a single config object for NextAuth, sync worker, and database modules.</summary>
    <subtasks>
      <item>Add integration checks proving /api/sync and NextAuth refuse to bootstrap when merged configuration is incomplete or stale.</item>
    </subtasks>
    <sources>docs/PRD.md:165; docs/architecture.md:125</sources>
  </task>
  <task id="T3" ac="AC3">
    <summary>Implement a startup guard (validateConfig or server init hook) that halts deployment with actionable errors, emits Pino logs, and writes audit entries to sync_events when secrets or config records are missing or invalid.</summary>
    <subtasks>
      <item>Route missing-secret alerts into governance monitoring via log-based metrics or Cloud Monitoring.</item>
    </subtasks>
    <sources>docs/epics.md:84; docs/architecture.md:21</sources>
  </task>
  <task id="T4" ac="AC4">
    <summary>Refactor lib/auth.ts, lib/google-sheets.ts, and Mongo bootstrap routines to import the shared config and secrets modules instead of reading process environment variables directly.</summary>
    <subtasks>
      <item>Reuse session middleware and logging utilities from story 1-3 to keep audit patterns consistent.</item>
    </subtasks>
    <sources>docs/architecture.md:125; docs/stories/1-3-session-middleware-and-audit-logging-for-auth-failures.md:1</sources>
  </task>
</tasks>
  </story>

  <acceptanceCriteria><criteria>
  <item id="AC1">App Engine runtime fetches GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, session signing key, Mongo connection string, and Sheets service credentials from Secret Manager at startup with caching plus documented rotation path.</item>
  <item id="AC2">Configuration loader merges secrets with allowlist, sheet ID, and collection metadata from Story A1's config collection so /api/sync and NextAuth run using the latest operator inputs without redeploying.</item>
  <item id="AC3">Startup fails fast with actionable error messaging and audit logging if any required secret is missing, invalid, or fails decryption, preventing the service from running with partial configuration.</item>
  <item id="AC4">Calling services (NextAuth, sync workers, database bootstrap) read from the shared config module instead of accessing environment variables directly, ensuring a single authoritative secret source.</item>
</criteria></acceptanceCriteria>

  <artifacts>
    <docs>
  <artifact path="docs/epics.md" title="Epic A" section="Story [A4]: Secure secrets and configuration loading" snippet="As a platform owner, I want Sheets API credentials and Mongo connection strings stored in Google Secret Manager so secrets never land in code or logs. App Engine service retrieves secrets at startup with caching and refresh on rotation, and the configuration loader merges them with Story A1's Mongo config values." />
  <artifact path="docs/architecture.md" title="Architecture" section="Security Architecture" snippet="Secrets: Google Secret Manager supplies GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, and the session signing key via a server-only loader. Secret Manager integration requires the App Engine service account with roles/secretmanager.secretAccessor and injects secrets at runtime via environment variables." />
  <artifact path="docs/PRD.md" title="PRD" section="Functional Requirements / FR-003" snippet="FR-003 mandates that configuration is persisted in the MongoDB config collection so /api/sync reads values without code change. The Security section also states that credentials and secrets (Sheets API, Mongo connection string) must live in Google Secret Manager and never be committed to source." />
  <artifact path="docs/stories/1-3-session-middleware-and-audit-logging-for-auth-failures.md" title="Story 1.3" section="Learnings" snippet="New middleware and logging utilities already exist (lib/auth/sessionMiddleware.ts, lib/logging.ts, tests under tests/unit/lib/auth) and should be reused when wiring secrets/config rather than duplicating auth or logging code. Completion notes also highlight structured logging expectations and alert thresholds for auth failures." />
  <artifact path="docs/stories/1-1-persist-admissions-manager-allowlist.md" title="Story 1.1" section="Story" snippet="Config collection persists allowlisted manager emails, Devices sheet ID, and Mongo collection name so /api/sync reads operator inputs without redeploying—these fields must merge with hydrated secrets in Story 1.4." />
  <artifact path="docs/stories/1-2-implement-google-oauth-restricted-to-admissions-managers.md" title="Story 1.2" section="Dev Notes" snippet="Google OAuth sign-in reuses the Config collection and requires secrets to load from Secret Manager at runtime; unauthorized attempts must log structured governance data." />
</docs>
    <code>
  <artifact path="nyu-device-roster/src/lib/auth/sessionMiddleware.ts" kind="middleware" symbol="withSession" lines="82-130" reason="Wraps API route handlers with NextAuth session enforcement, logs failures, and persists audit records—new config/secrets modules must plug into the same guard instead of bypassing it." />
  <artifact path="nyu-device-roster/src/lib/config.ts" kind="config-loader" symbol="loadConfig" lines="14-38" reason="Fetches and caches the Mongo-backed config document that stores allowlist, sheet ID, and collection metadata; AC2 requires merging this payload with hydrated secrets." />
  <artifact path="nyu-device-roster/src/lib/auth/options.ts" kind="auth-config" symbol="authOptions" lines="61-175" reason="NextAuth callbacks already validate Google identity against the config collection and enforce logging, so secrets must be injected here instead of ad-hoc env reads." />
  <artifact path="nyu-device-roster/src/lib/logging.ts" kind="logging" symbol="logAuthFailure|logAuthAlert|logAuthSuccess" lines="31-45" reason="Central Pino logger ensures governance-grade telemetry; the startup guard and secret loader must reuse these helpers for structured events." />
  <artifact path="nyu-device-roster/src/lib/db.ts" kind="database" symbol="connectToDatabase" lines="12-36" reason="All config/secrets persistence and audit writes share this connection helper, so any startup guard or rotation audit must invoke it rather than opening new clients." />
  <artifact path="nyu-device-roster/src/lib/audit/syncEvents.ts" kind="audit-writer" symbol="recordAuthFailureEvent" lines="13-26" reason="Provides the accepted shape for governance events; missing-secret alerts should emit through the same model to keep dashboards consistent." />
</code>
    <dependencies>
  <ecosystem name="node (package.json)">
    <package name="next" version="16.0.1" note="App Router runtime that will host the secrets/config loader." />
    <package name="next-auth" version="^4.24.13" note="Provides Google OAuth + session enforcement; callbacks already pull from loadConfig." />
    <package name="mongoose" version="^8.19.3" note="Used by loadConfig and audit writers—secret rotation events must reuse the same connection." />
    <package name="pino" version="^10.1.0" note="Structured logging pipeline for audit + governance dashboards." />
    <package name="dotenv" version="^17.2.3" note="Current local bootstrap for env vars; new Secret Manager loader should supersede ad-hoc dotenv usage." />
    <package name="zod" version="^4.1.12" note="Config schema validation; merged config/secrets object should continue to validate against these contracts." />
  </ecosystem>
</dependencies>
  </artifacts>

  <constraints>
  <constraint source="docs/architecture.md:293-304">Secret Manager access must flow through the App Engine service account with roles/secretmanager.secretAccessor and surface secrets only via runtime env loaders—local `.env` fallbacks violate deployment expectations.</constraint>
  <constraint source="docs/epics.md:83-84">Startup must fail fast with an actionable error and audit entry whenever required secrets are missing or invalid; partial configuration is not allowed.</constraint>
  <constraint source="docs/PRD.md:165-199">Configuration data (allowlist, sheet ID, collection metadata) lives in the Mongo `config` collection and operators expect `/api/sync` to read it without redeploy, so the merged secrets/config object must refresh from that source.</constraint>
  <constraint source="docs/stories/1-3-session-middleware-and-audit-logging-for-auth-failures.md:1-40">Structured logging and audit fan-out already run through lib/logging.ts and lib/audit/syncEvents.ts, so missing-secret alerts must reuse those channels to keep governance dashboards aligned.</constraint>
</constraints>
  <interfaces>
  <interface name="withSession" kind="middleware" signature="withSession<TContext>(handler: SessionRouteHandler<TContext>): (request: NextRequest, context: TContext) => Promise<Response>" path="nyu-device-roster/src/lib/auth/sessionMiddleware.ts" />
  <interface name="connectToDatabase" kind="database" signature="connectToDatabase(uri = process.env.MONGODB_URI): Promise<typeof mongoose>" path="nyu-device-roster/src/lib/db.ts" />
  <interface name="GET /api/session" kind="REST endpoint" signature="GET /api/session → 200 { status: 'ok', manager: { email, role } } (requires withSession)" path="nyu-device-roster/src/app/api/session/route.ts" />
</interfaces>
  <tests>
    <standards>Architecture doc (docs/architecture.md:202-210) mandates co-located unit tests plus Playwright/Vitest suites driven via npm run test and npm run test:e2e; structured logging plus audit hooks must be asserted with mocks like tests/unit/lib/auth/sessionMiddleware.test.ts.</standards>
    <locations>nyu-device-roster/tests/unit/**, nyu-device-roster/tests/integration/**, src/lib/**/__tests__.</locations>
    <ideas>
      <idea ac="AC1">Unit-test lib/secrets.ts to ensure it calls Secret Manager client with expected secret IDs, caches values, and refreshes when rotation metadata changes.</idea>
      <idea ac="AC1">Add failure-path tests asserting the startup guard logs via logAuthFailure/logAuthAlert and writes audit records when Secret Manager returns 404/permission errors.</idea>
      <idea ac="AC2">Integration test loadConfig + new config merge to prove /api/sync (or a stub consumer) receives Story A1 fields plus hydrated secrets and rejects incomplete payloads.</idea>
      <idea ac="AC3">Simulate missing secret/config combinations to ensure validateConfig halts boot with actionable errors and records sync_events entries.</idea>
      <idea ac="AC4">Refactor consumer modules (auth/session middleware, planned lib/google-sheets.ts enhancements, Mongo bootstrap) under tests to verify they read from the shared config/secrets accessor instead of process.env.</idea>
    </ideas>
  </tests>
</story-context>
